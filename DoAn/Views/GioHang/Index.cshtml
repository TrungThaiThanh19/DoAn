@model DoAn.ViewModel.GioHangVMD
@using Microsoft.AspNetCore.Antiforgery
@inject IAntiforgery Antiforgery
@{
    ViewData["Title"] = "Giỏ hàng";
    var tokens = Antiforgery.GetAndStoreTokens(Context);
}

@functions {
    string ImgSrc(string? path)
    {
        const string placeholder = "https://via.placeholder.com/72?text=IMG";
        if (string.IsNullOrWhiteSpace(path)) return placeholder;
        if (path.StartsWith("http", StringComparison.OrdinalIgnoreCase)) return path;
        if (path.StartsWith("~/") || path.StartsWith("/")) return Url.Content(path);
        if (path.StartsWith("images/", StringComparison.OrdinalIgnoreCase)) return Url.Content("~/" + path);
        return Url.Content("~/images/" + path);
    }
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
    /* ====== HEADER (copy từ Shop) ====== */
    .shp-header {
        background: linear-gradient(180deg,#ff7043,#ff5a3c 45%, #ff4d2e);
        color: #fff;
    }

    .shp-topbar {
        font-size: .95rem;
        opacity: .95;
    }

    .shp-brand {
        display: flex;
        align-items: center;
        gap: 10px;
        color: #fff;
        text-decoration: none;
        font-weight: 800;
        font-size: 1.5rem;
    }

        .shp-brand img {
            height: 36px;
            width: auto;
        }

    .shp-search {
        position: relative;
        max-width: 720px;
        width: 100%;
    }

        .shp-search input {
            height: 44px;
            border-radius: 999px;
            border: 0;
            padding-left: 18px;
            padding-right: 54px;
        }

        .shp-search button {
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            border-radius: 999px;
            height: 36px;
            width: 44px;
            border: 0;
            background: #fff;
            color: #ff4d2e;
        }

    .shp-icons a {
        color: #fff;
        text-decoration: none;
        margin-left: 18px;
        position: relative;
    }

    .shp-icons .badge {
        position: absolute;
        top: -6px;
        right: -10px;
        background: #fff;
        color: #ff4d2e;
        border-radius: 999px;
        font-size: .7rem;
    }

    /* ====== CART ====== */
    :root {
        --brand: #ee4d2d;
        --ink: #1f2937;
        --muted: #64748b;
        --line: #e5e7eb;
        --bg: #f6f7f9;
    }

    .cart-wrap {
        max-width: 1100px;
        margin: 24px auto 110px;
    }

    .cart-title {
        font-size: 24px;
        font-weight: 800;
        margin-bottom: 16px;
        color: #111827;
    }

    .cart-header, .cart-row {
        display: grid;
        grid-template-columns: 36px 1fr 140px 160px 140px 100px;
        column-gap: 12px;
        align-items: center;
    }

    .cart-header {
        padding: 14px 16px;
        background: #fff;
        border: 1px solid var(--line);
        border-radius: 8px;
        color: #6b7280;
        font-weight: 700;
        position: sticky;
        top: 0;
        z-index: 3;
    }

    .shop-block {
        background: #fff;
        border: 1px solid var(--line);
        border-radius: 10px;
        margin-top: 14px;
    }

    .shop-top {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 16px;
        border-bottom: 1px dashed var(--line);
    }

    .shop-name {
        font-weight: 800;
        color: #111827;
    }

    .voucher-link {
        color: #2563eb;
        text-decoration: none;
        font-weight: 600;
    }

    .voucher-row {
        padding: 10px 16px;
        border-top: 1px dashed var(--line);
        color: #334155;
    }

    .cart-row {
        padding: 14px 16px;
    }

        .cart-row + .cart-row {
            border-top: 1px solid var(--line);
        }

    .prod {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .thumb {
        width: 72px;
        height: 72px;
        border-radius: 10px;
        border: 1px solid var(--line);
        object-fit: cover;
    }

    .pname {
        font-weight: 700;
        color: #111827;
    }

    .pmeta {
        color: #94a3b8;
        font-size: 12px;
    }

    .price, .total {
        font-weight: 800;
        color: #111827;
        text-align: right;
    }

    .qty-box {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0;
    }

        .qty-box button {
            width: 28px;
            height: 28px;
            border: 1px solid var(--line);
            background: #fff;
        }

        .qty-box input {
            width: 56px;
            text-align: center;
            border: 1px solid var(--line);
            height: 28px;
            margin: 0 -1px;
        }

    .act a {
        color: #ef4444;
        text-decoration: none;
        font-weight: 700;
    }

    .empty {
        background: var(--bg);
        padding: 24px;
        border-radius: 10px;
        text-align: center;
        color: #64748b;
    }

    .cart-footer {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        background: #fff;
        border-top: 1px solid var(--line);
        box-shadow: 0 -6px 18px rgba(0,0,0,.06);
        z-index: 5;
    }

    .foot-inner {
        max-width: 1100px;
        margin: 0 auto;
        padding: 12px 16px;
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .foot-left {
        display: flex;
        align-items: center;
        gap: 12px;
        flex: 1;
        color: #334155;
    }

    .foot-right {
        display: flex;
        align-items: center;
        gap: 14px;
    }

    .sum {
        font-weight: 800;
        color: #ef4444;
        font-size: 18px;
    }

    .btn-primary {
        background: linear-gradient(135deg,#ff6a3d,var(--brand));
        color: #fff;
        border: 0;
        padding: 10px 18px;
        border-radius: 8px;
        font-weight: 800;
    }

        .btn-primary:disabled {
            opacity: .6;
            filter: grayscale(.2);
        }

    .btn-link {
        background: transparent;
        border: 0;
        color: #ef4444;
        font-weight: 700;
    }

    .chk {
        width: 18px;
        height: 18px;
    }



    {
        grid-template-columns: 28px 1fr 100px 120px 110px 80px;
    }

    }
</style>

<!-- ===== HEADER giống Shop ===== -->
<header class="shp-header">
    <div class="container py-2 shp-topbar d-flex justify-content-between">
        <div class="d-none d-md-flex gap-3">
        </div>
        <div class="d-flex gap-3">
            <a class="text-white text-decoration-none" href="/TaiKhoan/Register">Đăng Ký</a>
            <span class="text-white-50">|</span>
            <a class="text-white text-decoration-none" href="/TaiKhoan/Login">Đăng Nhập</a>
        </div>
    </div>
    <div class="container py-3">
        <div class="d-flex align-items-center gap-3">
            <a href="~/" class="shp-brand">
                <img src="~/images/logo.png" alt="Logo" />
                <span>ShopPerfume</span>
            </a>
            <form asp-controller="Shop" asp-action="Index" method="get" class="flex-grow-1 shp-search">
                <input name="search" class="form-control" placeholder="Tìm kiếm sản phẩm..." />
                <button type="submit"><i class="fa-solid fa-magnifying-glass"></i></button>
            </form>
            <div class="shp-icons d-flex align-items-center">
                <a href="/GioHang/Index">
                    <i class="fa-solid fa-cart-shopping fa-lg"></i>
                    <span class="badge" id="cart-badge" style="display:none">0</span>
                </a>
            </div>
        </div>
    </div>
</header>

<!-- ===== CART ===== -->
<div class="cart-wrap">
    <div class="cart-title">Giỏ hàng</div>

    @if (Model == null || !Model.Items.Any())
    {
        <div class="empty">
            Giỏ hàng trống. <a href="@Url.Action("Index","Shop")" class="voucher-link">Tiếp tục mua sắm →</a>
        </div>
    }
    else
    {
        <div class="cart-header">
            <div><input id="chkAllTop" type="checkbox" class="chk" /></div>
            <div>Sản phẩm</div>
            <div class="text-end">Đơn giá</div>
            <div class="text-center">Số lượng</div>
            <div class="text-end">Số tiền</div>
            <div class="text-center">Thao tác</div>
        </div>

        <div class="shop-block" id="cart-list">
            <div class="shop-top">
                <input type="checkbox" class="chk" id="chkShop" />
                <div class="shop-name">Giỏ hàng của bạn</div>
                <div class="ms-auto"><a href="#" class="voucher-link" onclick="event.preventDefault()">Thêm Mã giảm giá</a></div>
            </div>

            @foreach (var i in Model.Items)
            {
                var lineId = i.ChiTietGioHangId;
                <div class="cart-row" data-line="@lineId" data-unit="@i.DonGia" data-stock="@i.TonKho">
                    <div><input type="checkbox" class="chk chk-item" data-line="@lineId" /></div>

                    <div class="prod">
                        <img src="@ImgSrc(i.HinhAnh)" class="thumb" alt="@i.TenSanPham" />
                        <div>
                            <div class="pname">@i.TenSanPham</div>
                            <div class="pmeta">
                                @if (!string.IsNullOrWhiteSpace(i.ThuongHieu))
                                {
                                    @i.ThuongHieu

                                    <span> • </span>
                                }
                                @i.TheTich
                                @if (i.TonKho <= 5)
                                {
                                    <span> • <span style="color:#ef4444;font-weight:700">Còn @i.TonKho</span></span>
                                }
                            </div>
                        </div>
                    </div>

                    <div class="price text-end">@i.DonGia.ToString("n0") đ</div>

                    <div class="qty-box">
                        <button type="button" onclick="stepQty('@lineId', -1)">-</button>
                        <input type="number" min="1" value="@Math.Max(1, i.SoLuong)" id="qty-@lineId" oninput="qtyChanged('@lineId')" />
                        <button type="button" onclick="stepQty('@lineId', 1)">+</button>
                    </div>

                    <div class="total text-end" id="total-@lineId">@i.ThanhTien.ToString("n0") đ</div>

                    <div class="act text-center">
                        <a href="javascript:void(0)" onclick="removeLine('@lineId'); return false;">Xóa</a>
                        <form id="rm-@lineId" method="post" asp-action="Remove" class="d-none">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="chiTietGioHangId" value="@lineId" />
                        </form>
                    </div>
                </div>
            }

            <div class="voucher-row">
                <i class="fa-solid fa-truck-fast me-1"></i> Miễn phí vận chuyển cho đơn từ <b>500.000đ</b>.
            </div>
        </div>

        <div class="cart-footer">
            <div class="foot-inner">
                <div class="foot-left">
                    <input id="chkAllBottom" type="checkbox" class="chk" />
                    <label for="chkAllBottom" class="mb-0">Chọn tất cả (<span id="sel-count">0</span>)</label>
                    <button class="btn-link" type="button" onclick="removeSelected()">Xóa</button>
                </div>
                <div class="foot-right">
                    <div>Tổng cộng (<span id="sel-count-2">0</span> sản phẩm): <span class="sum" id="sel-sum">0 đ</span></div>
                    <button class="btn-primary" id="btnCheckout" disabled>Mua hàng</button>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        const csrfHeader='@tokens.HeaderName', csrfToken='@tokens.RequestToken';
        const fmt = n => (n||0).toLocaleString('vi-VN') + ' đ';

        const chkAllTop = document.getElementById('chkAllTop');
        const chkAllBottom = document.getElementById('chkAllBottom');
        const chkShop = document.getElementById('chkShop');

        function itemChecks(){ return Array.from(document.querySelectorAll('.chk-item')); }

        function applyAll(checked){
          itemChecks().forEach(c=>c.checked=checked);
          recalc();
        }
        chkAllTop?.addEventListener('change', e=>applyAll(e.target.checked));
        chkAllBottom?.addEventListener('change', e=>applyAll(e.target.checked));
        chkShop?.addEventListener('change', e=>applyAll(e.target.checked));
        itemChecks().forEach(c=>c.addEventListener('change', recalc));

        function clampByStock(lineId, value){
          const row = document.querySelector(`.cart-row[data-line="${lineId}"]`);
          const stock = parseInt(row?.dataset.stock || '1', 10);
          let v = parseInt(value || '1', 10);
          if(isNaN(v)) v = 1;
          v = Math.max(1, Math.min(v, Math.max(1, stock)));
          return v;
        }

        function stepQty(lineId, step){
          const ip = document.getElementById('qty-'+lineId);
          let v = clampByStock(lineId, (parseInt(ip.value||'1',10) + step));
          ip.value = v;
          sendUpdate(lineId, v);
        }

        function qtyChanged(lineId){
          const ip = document.getElementById('qty-'+lineId);
          let v = clampByStock(lineId, ip.value);
          ip.value = v;
          clearTimeout(ip._t); ip._t = setTimeout(()=>sendUpdate(lineId, v), 250);
        }

        function sendUpdate(lineId, qty){
          fetch('@Url.Action("UpdateAjax", "GioHang")', {
            method:'POST',
            headers:{ 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8', [csrfHeader]:csrfToken },
            body:new URLSearchParams({ chiTietGioHangId: lineId, soLuong: qty })
          })
          .then(r=>r.ok?r.json():Promise.reject())
          .then(d=>{
            if(!d || !d.ok) return;
            document.getElementById('total-'+lineId).textContent = fmt(d.lineTotal);
            if(typeof d.qty === 'number'){ document.getElementById('qty-'+lineId).value = d.qty; }
            recalc(true, d.subtotal);
          })
          .catch(()=>{});
        }

        function removeLine(lineId){ document.getElementById('rm-'+lineId)?.submit(); }
        function removeSelected(){
          const ids = itemChecks().filter(c=>c.checked).map(c=>c.dataset.line);
          if(!ids.length) return; ids.forEach(id=>document.getElementById('rm-'+id)?.submit());
        }

        function recalc(){
          const items = itemChecks();
          const sel = items.filter(c=>c.checked);
          document.getElementById('sel-count').textContent = sel.length;
          document.getElementById('sel-count-2').textContent = sel.length;

          let sum = 0;
          sel.forEach(c=>{
            const row = document.querySelector(`.cart-row[data-line="${c.dataset.line}"]`);
            const unit = parseFloat(row?.dataset.unit || '0');
            const qty  = clampByStock(c.dataset.line, (document.getElementById('qty-'+c.dataset.line)?.value));
            sum += unit * qty;
          });
          document.getElementById('sel-sum').textContent = fmt(sum);
          document.getElementById('btnCheckout').disabled = sel.length === 0;

          const all = sel.length===items.length && items.length>0;
          chkAllTop.checked = all; chkAllBottom.checked = all; chkShop && (chkShop.checked = all);
        }
        recalc();
                // ==== MUA HÀNG: mang theo các dòng đã tick sang trang Địa chỉ ====
        const btnCheckout = document.getElementById('btnCheckout');
        btnCheckout?.addEventListener('click', () => {
          const ids = itemChecks().filter(c => c.checked).map(c => c.dataset.line);
          if (ids.length === 0) return;
          const url = '@Url.Action("Address", "Checkout")' + '?lines=' + encodeURIComponent(ids.join(','));
          window.location.href = url;
        });
    </script>
}