@model List<DoAn.ViewModels.HoaDonViewModel>
@{
    ViewData["Title"] = "Quản lý hóa đơn";
    var loaiHD = (ViewBag.LoaiHoaDon as string)?.Trim();
    var trangThai = ViewBag.TrangThai as int?;
    Layout = "~/Views/Shared/_AdminLayout.cshtml";

    string Money(decimal v) => string.Format("{0:N0} VND", v);
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

<h2 class="mb-3">Quản lý hóa đơn</h2>

<!-- Tabs trạng thái -->
<div class="btn-group mb-3">
    <a class="btn btn-outline-secondary @(trangThai == null ? "active" : "")"
       asp-route-loaiHoaDon="@loaiHD" asp-route-trangThai="">Tất cả</a>
    <a class="btn btn-outline-secondary @(trangThai == 0 ? "active" : "")"
       asp-route-loaiHoaDon="@loaiHD" asp-route-trangThai="0">Chờ xác nhận</a>
    <a class="btn btn-outline-secondary @(trangThai == 1 ? "active" : "")"
       asp-route-loaiHoaDon="@loaiHD" asp-route-trangThai="1">Xác nhận</a>
    <a class="btn btn-outline-secondary @(trangThai == 2 ? "active" : "")"
       asp-route-loaiHoaDon="@loaiHD" asp-route-trangThai="2">Vận chuyển</a>
    <a class="btn btn-outline-secondary @(trangThai == 3 ? "active" : "")"
       asp-route-loaiHoaDon="@loaiHD" asp-route-trangThai="3">Thanh toán</a>
    <a class="btn btn-outline-secondary @(trangThai == 4 ? "active" : "")"
       asp-route-loaiHoaDon="@loaiHD" asp-route-trangThai="4">Hoàn thành</a>
    <a class="btn btn-outline-secondary @(trangThai == 5 ? "active" : "")"
       asp-route-loaiHoaDon="@loaiHD" asp-route-trangThai="5">Hủy</a>
</div>

<!-- Lọc loại hóa đơn -->
<form method="get" class="mb-3 d-flex align-items-center gap-2">
    <label for="loaiHoaDon">Lọc loại hóa đơn:</label>
    <select name="loaiHoaDon" id="loaiHoaDon" class="form-select w-auto" onchange="this.form.submit()">
        <option value="">-- Tất cả --</option>

        @if (string.Equals(loaiHD, "online", StringComparison.OrdinalIgnoreCase))
        {
            <option value="online" selected>Online</option>
        }
        else
        {
            <option value="online">Online</option>
        }

        @if (string.Equals(loaiHD, "offline", StringComparison.OrdinalIgnoreCase))
        {
            <option value="offline" selected>Offline</option>
        }
        else
        {
            <option value="offline">Offline</option>
        }
    </select>
</form>

<!-- Bảng dữ liệu -->
<table class="table table-striped table-bordered text-center align-middle">
    <thead class="table-warning">
        <tr>
            <th>STT</th>
            <th>Mã hóa đơn</th>
            <th>Tên khách hàng</th>
            <th>Nhân viên</th>
            <th class="text-start">Loại</th>
            <th>Ngày tạo</th>
            <th>Tiền giảm</th>
            <th>Phụ thu</th>
            <th>Tổng tiền</th>
            <th>Trạng thái</th>
            <th>Thao tác</th>
        </tr>
    </thead>
    <tbody>
        @if (Model != null && Model.Count > 0)
        {
            for (int i = 0; i < Model.Count; i++)
            {
                var item = Model[i];
                var isOnline = string.Equals(item.LoaiHoaDon?.Trim(), "online", StringComparison.OrdinalIgnoreCase);

                <tr>
                    <td>@(i + 1)</td>
                    <td>@item.Ma_HoaDon</td>
                    <td>@(string.IsNullOrWhiteSpace(item.HoTen) ? "Khách lẻ" : item.HoTen)</td>
                    <td>@(string.IsNullOrWhiteSpace(item.NhanVienTen) ? "Không có" : item.NhanVienTen)</td>

                    <td class="text-start">
                        @if (isOnline)
                        {
                            <span><i class="fa-solid fa-circle text-success me-1"></i> Online</span>
                        }
                        else
                        {
                            <span><i class="fa-solid fa-circle text-danger me-1"></i> Offline</span>
                        }
                    </td>

                    <td>@item.NgayTao.ToString("HH:mm:ss dd-MM-yyyy")</td>

                    <!-- Tiền giảm (khuyến mãi/voucher) -->
                    <td>@Money(item.TienGiam)</td>

                    <!-- Phụ thu / phí vận chuyển -->
                    <td>@Money(item.PhuThu)</td>

                    <!-- Tổng phải thu (đã gồm ship) -->
                    <td>@Money(item.TongTienSauGiam)</td>

                    <td>
                        @item.TrangThaiText
                        @* Dấu hiệu: khách đã gửi yêu cầu hoàn (chưa hoàn tiền) *@
                        @if (item.HasReturnRequest && !item.HasReturnDone)
                        {
                            <span class="badge rounded-pill bg-warning text-dark ms-1" title="Khách đã gửi yêu cầu hoàn hàng">
                                <i class="fa-solid fa-rotate-left me-1"></i>Y/c hoàn
                            </span>
                        }
                    </td>

                    <td>
                        <a asp-action="Details" asp-route-id="@item.ID_HoaDon"
                           class="btn btn-warning btn-sm" title="Xem chi tiết">
                            <i class="fa-regular fa-eye"></i>
                        </a>
                    </td>
                </tr>
            }
        }
        else
        {
            <tr><td colspan="11" class="text-muted">Không có hóa đơn nào.</td></tr>
        }
    </tbody>
</table>
