@model DoAn.Models.HoaDon
@{
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    ViewData["Title"] = "Chi tiết hóa đơn";

    // Bước trạng thái
    var steps = new[] { "Chờ xác nhận", "Đã xác nhận", "Đang vận chuyển", "Đã thanh toán", "Thành công" };
    var active = Math.Clamp(Model.TrangThai, 0, steps.Length - 1);

    // Loại hóa đơn: chỉ Online mới được chuyển trạng thái
    var loai = (Model.LoaiHoaDon ?? "").Trim().ToLower();
    var isOnline = loai == "online"; // nếu DB có "tại quầy" thì vẫn là offline

    // Tính tiền
    decimal subtotal = Model.HoaDonChiTiets?.Sum(x => x.SoLuong * x.DonGia) ?? 0m;
    decimal shipping = Model.PhuThu ?? 0m;
    decimal total = Model.TongTienSauGiam != 0
        ? Model.TongTienSauGiam
        : subtotal + shipping;

    string Currency(decimal v) => string.Format("{0:N0} VND", v);
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
<style>
    .page-title {
        font-weight: 900;
        letter-spacing: .2px
    }

    .order-head {
        background: linear-gradient(180deg,#eef2ff,#f8fafc);
        border: 1px solid #e5e7eb;
        border-radius: 18px
    }

    .stepper {
        display: flex;
        align-items: center;
        gap: 20px;
        padding: 18px
    }

    .step {
        text-align: center;
        flex: 1;
        position: relative;
        color: #6b7280
    }

        .step:not(:last-child)::after {
            content: "";
            position: absolute;
            top: 22px;
            left: 50%;
            right: -50%;
            height: 4px;
            background: #e5e7eb;
            z-index: 0
        }

    .dot {
        width: 40px;
        height: 40px;
        border-radius: 999px;
        background: #d1d5db;
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 8px;
        font-weight: 800;
        position: relative;
        z-index: 1
    }

    .step.done .dot {
        background: #22c55e
    }

    .step.active .dot {
        background: #0d6efd
    }

    .step.done, .step.active {
        color: #111827;
        font-weight: 700
    }

    .badge-soft {
        background: #eff6ff;
        color: #0d6efd;
        font-weight: 700;
        border-radius: 999px;
        padding: 6px 12px
    }

    .card-soft {
        border: 1px solid #e5e7eb;
        border-radius: 16px
    }

    .table thead th {
        background: #f1f5f9;
        color: #0f172a;
        font-weight: 800
    }

    .total-row td {
        font-weight: 800
    }
</style>

<div class="container py-3">
    <div class="d-flex align-items-center justify-content-between mb-3">
        <h2 class="page-title mb-0">Chi tiết đơn hàng: @Model.Ma_HoaDon</h2>
        <span class="badge-soft"><i class="fa-solid fa-circle me-1"></i>@steps[active]</span>
    </div>

    <!-- Stepper -->
    <div class="order-head mb-4">
        <div class="stepper">
            @for (int i = 0; i < steps.Length; i++)
            {
                var cls = i < active ? "step done" : i == active ? "step active" : "step";
                <div class="@cls">
                    <div class="dot">@((i + 1))</div>
                    <div>@steps[i]</div>
                </div>
            }
        </div>
    </div>

    <!-- Nút chuyển trạng thái: CHỈ hiện với hóa đơn Online -->
    @if (isOnline && Model.TrangThai < steps.Length - 1)
    {
        <form asp-action="CapNhatTrangThai" method="post" class="text-end mb-4">
            @Html.AntiForgeryToken()
            <input type="hidden" name="idHoaDon" value="@Model.ID_HoaDon" />
            <button class="btn btn-success px-4 py-2">
                <i class="fa-solid fa-hand-point-right me-2"></i>
                Chuyển sang bước: <strong>@steps[Model.TrangThai + 1]</strong>
            </button>
        </form>
    }
    else if (isOnline && Model.TrangThai >= steps.Length - 1)
    {
        <div class="alert alert-success"><i class="fa-solid fa-check-circle me-1"></i> Đơn hàng đã hoàn tất.</div>
    }
    @* Nếu là Offline: không render gì *@

    <div class="row g-3">
        <!-- Thông tin chung -->
        <div class="col-lg-7">
            <div class="card card-soft">
                <div class="card-body">
                    <h5 class="fw-bold mb-3"><i class="fa-regular fa-clipboard me-2"></i>Thông tin đơn hàng</h5>
                    <div class="row g-2">
                        <div class="col-6"><div class="text-muted">Mã hóa đơn</div><div class="fw-bold">@Model.Ma_HoaDon</div></div>
                        <div class="col-6"><div class="text-muted">Ngày tạo</div><div class="fw-bold">@Model.NgayTao.ToString("dd/MM/yyyy HH:mm")</div></div>
                        <div class="col-6"><div class="text-muted">Loại hóa đơn</div><div class="fw-bold">@Model.LoaiHoaDon</div></div>
                        <div class="col-6"><div class="text-muted">Hình thức thanh toán</div><div class="fw-bold">@Model.HinhThucThanhToan</div></div>
                    </div>
                    <hr />
                    <h5 class="fw-bold mb-3"><i class="fa-solid fa-box-open me-2"></i>Sản phẩm</h5>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th style="width:56px">#</th>
                                    <th>Tên sản phẩm</th>
                                    <th style="width:120px" class="text-center">Số lượng</th>
                                    <th style="width:160px" class="text-end">Đơn giá</th>
                                    <th style="width:180px" class="text-end">Thành tiền</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.HoaDonChiTiets != null && Model.HoaDonChiTiets.Any())
                                {
                                    var idx = 1;
                                    foreach (var item in Model.HoaDonChiTiets)
                                    {
                                        var ten = item.SanPhamChiTiet?.SanPham?.Ten_SanPham ?? "(Chưa nạp tên sản phẩm)";
                                        <tr>
                                            <td>@idx</td>
                                            <td>
                                                <div class="fw-bold">@ten</div>
                                            </td>
                                            <td class="text-center">@item.SoLuong</td>
                                            <td class="text-end">@Currency(item.DonGia)</td>
                                            <td class="text-end">@Currency(item.SoLuong * item.DonGia)</td>
                                        </tr>
                                        idx++;
                                    }
                                }
                                else
                                {
                                    <tr><td colspan="5" class="text-center text-muted">Chưa có sản phẩm.</td></tr>
                                }
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="4" class="text-end text-muted">Tạm tính</td>
                                    <td class="text-end">@Currency(subtotal)</td>
                                </tr>
                                <tr>
                                    <td colspan="4" class="text-end text-muted">Phụ thu</td>
                                    <td class="text-end">@Currency(shipping)</td>
                                </tr>
                                <tr class="total-row">
                                    <td colspan="4" class="text-end">Tổng thanh toán</td>
                                    <td class="text-end">@Currency(total)</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Người nhận -->
        <div class="col-lg-5">
            <div class="card card-soft h-100">
                <div class="card-body">
                    <h5 class="fw-bold mb-3"><i class="fa-regular fa-user me-2"></i>Thông tin người nhận</h5>
                    <div class="mb-2">
                        <div class="text-muted">Khách hàng</div>
                        <div class="fw-bold">@(!string.IsNullOrWhiteSpace(Model.HoTen) ? Model.HoTen : "Khách lẻ")</div>
                    </div>
                    <div class="mb-2">
                        <div class="text-muted">SĐT</div>
                        <div class="fw-bold">@Model.Sdt_NguoiNhan</div>
                    </div>
                    <div class="mb-2">
                        <div class="text-muted">Địa chỉ</div>
                        <div class="fw-bold">@Model.DiaChi</div>
                    </div>

                    <hr />
                    <div class="d-grid gap-2">
                        <a class="btn btn-outline-secondary" href="@Url.Action("Index","HoaDon")">
                            <i class="fa-solid fa-arrow-left-long me-2"></i>Quay lại danh sách
                        </a>

                        @* CHỈ Online mới có nút chuyển trạng thái *@
                        @if (isOnline && Model.TrangThai < steps.Length - 1)
                        {
                            <form asp-action="CapNhatTrangThai" method="post">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="idHoaDon" value="@Model.ID_HoaDon" />
                                <button class="btn btn-primary w-100">
                                    <i class="fa-regular fa-circle-right me-2"></i>
                                    Chuyển sang: <strong>@steps[Model.TrangThai + 1]</strong>
                                </button>
                            </form>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
