@model DoAn.Models.HoaDon
@{
    ViewData["Title"] = "Theo dõi đơn hàng " + Model.Ma_HoaDon;

    bool isCanceled = Model.TrangThai == 5;
    bool isReturnDone = Model.TrangThai == 7;

    // lấy log mới nhất theo trạng thái để hiển thị lý do/người thực hiện
    var cancelLog = Model.TrangThaiDonHangs?
        .Where(x => x.TrangThai == 5)
        .OrderByDescending(x => x.NgayChuyen)
        .FirstOrDefault();

    var returnDoneLog = Model.TrangThaiDonHangs?
        .Where(x => x.TrangThai == 7)
        .OrderByDescending(x => x.NgayChuyen)
        .FirstOrDefault();

    string Currency(decimal v) => string.Format("{0:N0} đ", v);
}

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

<style>
    .order-head {
        background: linear-gradient(180deg,#eef2ff,#f8fafc);
        border: 1px solid #e5e7eb;
        border-radius: 18px
    }

    .badge-soft {
        background: #eff6ff;
        color: #0d6efd;
        font-weight: 700;
        border-radius: 999px;
        padding: 6px 12px
    }

    .card-soft {
        border: 1px solid #e5e7eb;
        border-radius: 16px
    }

    .table thead th {
        background: #f1f5f9;
        color: #0f172a;
        font-weight: 800
    }
</style>

<h2 class="mb-2 text-primary fw-bold">
    <i class="fa fa-location-dot me-2"></i>Theo dõi đơn hàng: @Model.Ma_HoaDon
</h2>
<div class="text-muted mb-3">
    Cập nhật:
    <span id="updated">@((Model.NgayCapNhat ?? Model.NgayTao).ToString("dd/MM/yyyy HH:mm"))</span>
</div>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success"><i class="fa fa-check-circle me-1"></i>@TempData["Success"]</div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger"><i class="fa fa-triangle-exclamation me-1"></i>@TempData["Error"]</div>
}

@* ====== BANNER: ĐƠN ĐÃ HỦY ====== *@
@if (isCanceled && cancelLog != null)
{
    var byCustomer = string.Equals(cancelLog.NhanVienDoi, "Khách hàng", StringComparison.OrdinalIgnoreCase);
    <div class="alert alert-danger d-flex align-items-start">
        <i class="fa fa-circle-xmark me-2 mt-1"></i>
        <div>
            <div><strong>Đơn hàng đã bị hủy@(byCustomer ? " bởi khách hàng" : "")</strong>.</div>
            <div class="text-muted">Thời gian: @cancelLog.NgayChuyen.ToString("dd/MM/yyyy HH:mm")</div>
            @if (!string.IsNullOrWhiteSpace(cancelLog.NoiDungDoi))
            {
                <div><span class="text-muted">Lý do:</span> @cancelLog.NoiDungDoi</div>
            }
            @if (!string.IsNullOrWhiteSpace(cancelLog.NhanVienDoi))
            {
                <div><span class="text-muted">Người thực hiện:</span> @cancelLog.NhanVienDoi</div>
            }
        </div>
    </div>
}

@* ====== BANNER: HOÀN HÀNG THÀNH CÔNG ====== *@
@if (isReturnDone && returnDoneLog != null)
{
    <div class="alert alert-success d-flex align-items-start">
        <i class="fa fa-rotate-left me-2 mt-1"></i>
        <div>
            <div><strong>Hoàn hàng thành công</strong>.</div>
            <div class="text-muted">Thời gian: @returnDoneLog.NgayChuyen.ToString("dd/MM/yyyy HH:mm")</div>
            @if (!string.IsNullOrWhiteSpace(returnDoneLog.NoiDungDoi))
            {
                <div><span class="text-muted">Ghi chú:</span> @returnDoneLog.NoiDungDoi</div>
            }
            @if (!string.IsNullOrWhiteSpace(returnDoneLog.NhanVienDoi))
            {
                <div><span class="text-muted">Người xác nhận:</span> @returnDoneLog.NhanVienDoi</div>
            }
        </div>
    </div>
}

@* Khi đã hủy hoặc đã hoàn xong -> chỉ hiển thị banner trên, KHÔNG stepper *@
@if (!(isCanceled || isReturnDone))
{
    <!-- Nếu muốn giữ stepper cũ, bạn có thể chèn lại ở đây -->
}

<!-- Thông tin & chi tiết -->
<div class="card card-soft shadow-sm border-0">
    <div class="card-body">
        <h5 class="fw-bold mb-3"><i class="fa-solid fa-box-open me-2"></i>Chi tiết sản phẩm</h5>
        <div class="table-responsive">
            <table class="table align-middle">
                <thead>
                    <tr>
                        <th style="width:56px">#</th>
                        <th>Sản phẩm</th>
                        <th class="text-center" style="width:120px">SL</th>
                        <th class="text-end" style="width:160px">Đơn giá</th>
                        <th class="text-end" style="width:180px">Thành tiền</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        var idx = 1; decimal sum = 0;
                        if (Model.HoaDonChiTiets != null)
                        {
                            foreach (var it in Model.HoaDonChiTiets)
                            {
                                var ten = it.SanPhamChiTiet?.SanPham?.Ten_SanPham ?? "Sản phẩm";
                                var line = it.SoLuong * it.DonGia; sum += line;
                                <tr>
                                    <td>@idx</td>
                                    <td class="fw-semibold">@ten</td>
                                    <td class="text-center">@it.SoLuong</td>
                                    <td class="text-end">@Currency(it.DonGia)</td>
                                    <td class="text-end">@Currency(line)</td>
                                </tr>
                                idx++;
                            }
                        }
                    }
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="4" class="text-end text-muted">Tạm tính</td>
                        <td class="text-end">@Currency(Model.HoaDonChiTiets?.Sum(x => x.SoLuong * x.DonGia) ?? 0m)</td>
                    </tr>
                    <tr>
                        <td colspan="4" class="text-end text-muted">Phí vận chuyển</td>
                        <td class="text-end">@Currency(Model.PhuThu ?? 0m)</td>
                    </tr>
                    <tr>
                        <td colspan="4" class="text-end fw-bold">Tổng thanh toán</td>
                        <td class="text-end fw-bold text-danger">@Currency(Model.TongTienSauGiam)</td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div class="d-flex flex-wrap gap-2 mt-2">
            <a class="btn btn-outline-secondary" asp-action="Index">
                <i class="fa-solid fa-arrow-left-long me-1"></i>Quay lại danh sách
            </a>

            @* Cho phép hủy nếu trạng thái còn sớm (0/1) *@
            @if (Model.TrangThai <= 1)
            {
                <form asp-action="Huy" asp-controller="DonHang" method="post" class="d-flex align-items-center gap-2"
                      onsubmit="return confirm('Bạn chắc chắn muốn hủy đơn @Model.Ma_HoaDon ?');">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@Model.ID_HoaDon" />
                    <input type="text" name="lyDo" class="form-control" placeholder="Lý do hủy (tuỳ chọn)" style="max-width:360px" />
                    <button class="btn btn-danger">
                        <i class="fa-solid fa-ban me-1"></i>Hủy đơn
                    </button>
                </form>
            }

            @* Nút HOÀN HÀNG: chỉ hiện khi ĐÃ THANH TOÁN (3) và chưa hoàn xong *@
            @if (Model.TrangThai == 3)
            {
                <form asp-action="HoanHang" asp-controller="DonHang" method="post" class="d-inline"
                      onsubmit="return confirm('Xác nhận gửi yêu cầu hoàn hàng cho đơn @Model.Ma_HoaDon ?');">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@Model.ID_HoaDon" />
                    <button class="btn btn-warning">
                        <i class="fa-solid fa-rotate-left me-1"></i> Hoàn hàng
                    </button>
                </form>
            }
        </div>
    </div>
</div>
